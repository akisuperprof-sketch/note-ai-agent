# note記事自動生成AIエージェント 仕様書

**バージョン**: 1.5.0  
**作成日**: 2025-12-19  
**最終更新**: 2025-12-30  

---

## 1. 製品概要

### 1.1 製品名
**note記事自動生成AIエージェント**

### 1.2 製品説明
ノウハウや一次情報を入力するだけで、「わど式」戦略企画メソッドに基づいた高品質なnote記事を自動生成するWebアプリケーション。

### 1.3 参考システム
- URL: https://note-ai-agent-2.unionai.co.jp/
- 機能: AI記事生成プラットフォーム

### 1.4 ターゲットユーザー
- note記事を書きたいが、構成に悩む人
- ノウハウはあるが文章化が苦手な人
- 効率的に質の高い記事を量産したい人

---

## 2. 機能要件

### 2.1 コア機能

#### 2.1.1 入力機能
| 機能ID | 機能名 | 説明 | 優先度 |
|--------|--------|------|--------|
| F-001 | ノウハウ入力 | テキストエリアでノウハウ・一次情報を入力 | 必須 |
| F-002 | 戦略企画設定 | わど式に基づく6項目の設定 | 必須 |
| F-003 | 基本設定 | 文体・読者層・文字数等の設定 | 必須 |
| F-004 | 画像アップロード | 参照画像のアップロード（キャラクター・画風反映用） | 任意 |

#### 2.1.2 生成機能
| 機能ID | 機能名 | 説明 | 優先度 |
|--------|--------|------|--------|
| F-010 | タイトル生成 | 5つのタイトル候補を生成 | 必須 |
| F-011 | 構成案生成 | 記事の見出し構成を生成 | 必須 |
| F-012 | 本文生成 | Markdown形式で記事本文を生成 | 必須 |
| F-013 | 一括生成 | タイトル→構成→本文を自動で一括生成 | 必須 |
| F-014 | 画像生成 | 記事内容と参照画像に基づいたアイキャッチ生成 | 必須 |

#### 2.1.3 出力機能
| 機能ID | 機能名 | 説明 | 優先度 |
|--------|--------|------|--------|
| F-020 | プレビュー表示 | Markdownのリアルタイムプレビュー | 必須 |
| F-021 | コピー機能 | 生成結果をクリップボードにコピー | 必須 |
| F-022 | エクスポート | Markdownファイルとしてダウンロード | 推奨 |
| F-023 | メタディスクリプション | SEO用の説明文を自動生成 | 必須 |

#### 2.1.4 モード切替
| 機能ID | 機能名 | 説明 | 優先度 |
|--------|--------|------|--------|
| F-030 | 段階的制作モード | タブで段階的に生成を進める | 必須 |
| F-031 | 通常モード | 一括で記事全体を生成 | 必須 |

#### 2.1.5 履歴管理機能
| 機能ID | 機能名 | 説明 | 優先度 |
|--------|--------|------|--------|
| F-040 | 保存機能 | 生成されたタイトル、構成、本文、画像をローカルストレージに保存 | 必須 |
| F-041 | 履歴表示機能 | 保存された履歴一覧を表示し、選択して復元できる | 必須 |

---

## 3. 非機能要件

### 3.1 パフォーマンス
| 項目 | 要件 |
|------|------|
| 初期表示 | 3秒以内 |
| タイトル生成 | 10秒以内 |
| 構成案生成 | 15秒以内 |
| 本文生成（10,000文字） | 120秒以内 |

### 3.2 対応環境
| 項目 | 要件 |
|------|------|
| ブラウザ | Chrome, Safari, Firefox, Edge (最新版) |
| デバイス | PC, タブレット, スマートフォン |
| 画面サイズ | 320px以上（レスポンシブ対応） |

### 3.3 セキュリティ
| 項目 | 要件 |
|------|------|
| API Key | サーバーサイドで管理 (env) |
| HTTPS | 必須 |
| 入力サニタイズ | XSS対策実施 |

---

## 4. 技術仕様

### 4.1 技術スタック

#### フロントエンド
```yaml
Framework: React 18.2+
Language: TypeScript 5.0+
Build Tool: Vite 5.0+
Styling: Tailwind CSS 3.4+
State Management: React Context / useState
Storage: LocalStorage (for History Feature)
Markdown: react-markdown
Icons: Lucide React
```

#### バックエンド / AI
```yaml
Runtime: Vercel Serverless Functions (Node.js 20)
Text API: Google Gemini API
  - Primary: gemini-2.0-flash-exp
  - Backup: gemini-1.5-flash / pro

Image Generation (Prioritized Strategy):
  1. magen-3.0-generate-001 (Google)
  2. gemini-3-pro-image-preview (Google)
  3. nano-banana-pro-preview (Pollinations - Client-side URL fallback)
  4. gemini-2.0-flash-exp (Google - Fallback)

Image Analysis:
  - Model: gemini-1.5-flash (Vision features)
```

#### インフラ
```yaml
Hosting: Vercel
Source Control: GitHub
CI/CD: Vercel Git Integration
```

### 4.2 ディレクトリ構成
```
note-ai-agent/
├── .github/
├── api/
│   ├── generate-title.ts
│   ├── generate-outline.ts
│   └── generate-body.ts (画像生成ロジック含む)
├── src/
│   ├── components/
│   │   ├── common/
│   │   ├── input/
│   │   │   └── ReferenceImageInput.tsx (新規)
│   │   ├── generation/
│   │   │   └── BodyPreview.tsx (画像プレビュー機能追加)
│   │   ├── output/
│   │   └── history/
│   ├── contexts/
│   ├── hooks/
│   ├── lib/
│   ├── types/
│   ├── App.tsx
│   └── main.tsx
├── package.json
├── 予測見本プロンプト.md
└── 仕様書.md
```

---

## 5. 画像生成戦略詳細 (v1.3.0)

### 5.1 優先順位付き生成プロセス
1.  **Google最新モデル試行**: `magen-3.0-generate-001` および `gemini-3-pro-image-preview` をサーバーサイドで試行。
2.  **Pollinationsフォールバック**: Googleモデルが利用不可またはエラーの場合、`nano-banana-pro-preview` を指定したPollinations URLを生成。サーバーサイドでの待機（タイムアウト）を防ぐため、クライアントサイドでの直接読み込みを採用。
3.  **Fluxモデル**: 日本語テキスト描画に最適化するため、Pollinations利用時は最終的に `model=flux` 相当の挙動を想定（URLパラメータで制御）。

### 5.2 参照画像活用
1.  ユーザーが画像をアップロード。
2.  `gemini-1.5-flash` (Vision) が画像のキャラクター、画風、色使いを分析し、英語で説明文を生成。
3.  本文生成プロンプトに「ユーザーはこの添付画像のキャラクターやスタイルを使いたがっている」という強力な指示とともに説明文を注入。
4.  AIがこれをベースに、記事の内容に合った画像プロンプトを作成。

---

## 6. API仕様

### 6.1 タイトル生成 API

#### エンドポイント
```
POST /api/generate-title
```

#### リクエスト
```typescript
interface TitleRequest {
  knowhow: string;
  strategy?: {
    target?: string;
    concept?: string;
    strength?: string;
  };
  settings: {
    audience: 'beginner' | 'intermediate' | 'advanced' | 'general';
    style: 'polite' | 'formal' | 'friendly';
  };
}
```

#### レスポンス
```typescript
interface TitleResponse {
  success: boolean;
  titles?: string[];
  error?: string;
  strategy?: string;
}
```

### 6.2 構成案生成 API

#### エンドポイント
```
POST /api/generate-outline
```

#### リクエスト
```typescript
interface OutlineRequest {
  knowhow: string;
  selectedTitle: string;
  strategy?: {
    structure?: string;
  };
  settings: {
    wordCount: number;
    audience: string;
  };
}
```

#### レスポンス
```typescript
interface OutlineResponse {
  success: boolean;
  outline?: {
    sections: {
      level: number;      // 1=H2, 2=H3
      heading: string;
      summary: string;
    }[];
  };
  error?: string;
}
```

### 6.3 本文生成 API

#### エンドポイント
```
POST /api/generate-body
```

#### リクエスト
```typescript
interface BodyRequest {
  knowhow: string;
  selectedTitle: string;
  outline: {
    sections: { heading: string; summary: string }[];
  };
  strategy?: {
    otherInstructions?: string;
  };
  settings: {
    style: 'polite' | 'formal' | 'friendly';
    audience: string;
    wordCount: number;
  };
}
```

#### レスポンス
```typescript
interface BodyResponse {
  success: boolean;
  body?: {
    markdown: string;
    metaDescription: string;
    actualWordCount: number;
  };
  error?: string;
}
```

---

## 7. UI仕様

### 7.1 カラーパレット
```css
/* Primary */
--primary-50: #f0f9ff;
--primary-100: #e0f2fe;
--primary-500: #0ea5e9;
--primary-600: #0284c7;
--primary-700: #0369a1;

/* Neutral */
--gray-50: #f9fafb;
--gray-100: #f3f4f6;
--gray-200: #e5e7eb;
--gray-700: #374151;
--gray-900: #111827;

/* Accent */
--success: #10b981;
--warning: #f59e0b;
--error: #ef4444;
```

### 7.2 タイポグラフィ
```css
/* Font Family */
font-family: 'Noto Sans JP', sans-serif;

/* Font Sizes */
--text-xs: 0.75rem;
--text-sm: 0.875rem;
--text-base: 1rem;
--text-lg: 1.125rem;
--text-xl: 1.25rem;
--text-2xl: 1.5rem;
```

### 7.3 コンポーネント仕様

#### タブナビゲーション
- 4つのタブ: 入力 / タイトル案 / 構成案 / 本文
- アクティブタブはハイライト表示
- 未完了タブは非活性（段階的モード時）

#### アコーディオン
- 「戦略企画（わど式）」「基本設定」は展開可能
- デフォルトは閉じた状態
- 開閉アニメーション付き

#### ボタン
- Primary: 青系グラデーション
- Secondary: グレー
- Danger: 赤
- ホバー時に軽いスケールアップ

---

## 8. 入力パラメータ詳細

### 8.1 戦略企画（わど式）
| 項目 | フィールド名 | 説明 | 例 |
|------|-------------|------|-----|
| タイトル | title | 記事タイトル案 | 「Obsidianで第二の脳を作る」 |
| ターゲット・読者変容 | target | 想定読者と変化 | 「情報整理に悩む会社員 → 効率的に知識管理できる」 |
| 記事コンセプト | concept | 記事の核 | 「1週間で構築できるロードマップ」 |
| 記事の強み | strength | 差別化ポイント | 「初心者向け・具体的な手順」 |
| 記事構成 | structure | 大まかな構成 | 「Day1〜Day7の段階式」 |
| その他の指示 | otherInstructions | 追加要望 | 「FAQ追加」 |

### 8.2 基本設定
| 項目 | フィールド名 | 選択肢 | デフォルト |
|------|-------------|--------|----------|
| 文体 | style | ですます調 / である調 / フレンドリー | ですます調 |
| 読者層 | audience | 初心者 / 中級者 / 上級者 / 一般 | 初心者 |
| 文字数 | wordCount | 2500 / 5000 / 7500 / 10000 | 5000 |
| 画像テーマ | imageTheme | 任意テキスト | - |

---

## 9. エラーハンドリング

### 9.1 エラーコード
| コード | 説明 | ユーザーメッセージ |
|--------|------|------------------|
| E001 | API接続エラー | 接続に失敗しました。再試行してください。 |
| E002 | タイムアウト | 処理がタイムアウトしました。 |
| E003 | 入力不足 | ノウハウを入力してください。 |
| E004 | レート制限 | しばらく待ってから再試行してください。 |
| E005 | 生成失敗 | 生成に失敗しました。内容を変更してお試しください。 |

---

## 10. インフラ設定

### 10.1 環境変数
```env
# Gemini API (Required)
GEMINI_API_KEY=your_api_key_here

# Optional
NEXT_PUBLIC_APP_URL=https://your-domain.vercel.app
```

### 10.2 Vercel設定
```json
{
  "functions": {
    "api/*.ts": {
      "runtime": "nodejs20.x",
      "maxDuration": 60
    }
  }
}
```

### 10.3 プロジェクト管理情報
- **GitHub Repository**: https://github.com/akisuperprof-sketch/note-ai-agent
- **Vercel Project**: https://vercel.com/akisuperprof-gmailcoms-projects/note-ai-agent

---

## 11. 変更履歴

| 日付 | バージョン | 変更内容 | 担当者 |
|------|----------|---------|--------|
| 2025-12-19 | 1.0.0 | 初版作成 | AI Agent |
| 2025-12-20 | 1.1.0 | Gemini 2.0 Flash導入、APIキーヘルスチェック機能追加、フォールバック戦略強化 | AI Agent |
| 2025-12-26 | 1.3.0 | 参照画像アップロード機能、Magen/Flux優先の画像生成戦略、Pollinations URLフォールバック実装 | AI Agent |
| 2025-12-29 | 1.4.0 | プロンプトディレクトリ構成変更、2段階画像生成フロー（サムネ先行・章画像後追）の実装、サムネデザイン規定（下部文字配置） | AI Agent |
| 2025-12-30 | 1.5.0 | メタディスクリプションのUI表示実装、記事生成プロンプトの出力形式強化（セパレーター変更による安定化） | AI Agent |

---

## 12. プロンプト構成と運用フロー (v1.4.0)

### 12.1 ディレクトリ構成
プロンプト関連ファイルは `プロンプト/` ディレクトリに集約し、管理する。

```
note-ai-agent/
├── プロンプト/
│   ├── reverse_engineered_prompt.md       # [メイン] 記事生成＋サムネ画像指定（最新版）
│   ├── 章画像生成プロンプト.md            # [サブ] 章ごとの挿絵を追加生成するための専用プロンプト
│   ├── reverse_engineered_prompt_stage1.md # [バックアップ] 第一段階（旧版）プロンプト
│   ├── image_prompt_stage1.txt            # [バックアップ] 第一段階画像プロンプト（文字なし）
│   └── 改善プロンプト                     # [記録] 改善案ドラフト
└── reverse_engineered_prompt.md           # [システム参照用] プロンプト/reverse_engineered_prompt.md のコピー
```

### 12.2 画像生成運用フロー
スピードとクオリティを両立させるため、以下の「2段階生成フロー」を採用する。

#### 第1段階：記事生成＋サムネイル（スピード重視）
*   **タイミング**: 記事の初回生成時
*   **生成内容**:
    *   記事本文（Markdown）
    *   **トップ画像（サムネイル）のみ**
*   **サムネイル仕様**:
    *   文字あり（記事タイトル等）
    *   レイアウト: 被写体中央/バランス、**文字は下部中央（Bottom Center）配置**
    *   可読性確保: 下部に微かなダークグラデーションまたはぼかしを入れる
    *   プロンプト: `reverse_engineered_prompt.md` 内のサムネイル指定を使用
*   **除外**: 各章の区切り画像（挿絵）はこの段階では生成しない。

#### 第2段階：章画像の追加生成（オンデマンド）
*   **タイミング**: ユーザーからの追加指示（例：「第2章の画像を作って」）があった時
*   **生成内容**: 特定の章に対する挿絵
*   **画像仕様**:
    *   **文字なし**
    *   世界観・雰囲気を重視したEmotionalな画像
    *   プロンプト: `章画像生成プロンプト.md` を使用

### 12.3 画像プロンプト モード定義
| モード | 用途 | 画像の特徴 | 使用プロンプトファイル |
|:---|:---|:---|:---|
| **パターンA** | サムネイル | 文字あり（下部配置）、CTR重視、具体的 | `reverse_engineered_prompt.md` |
| **パターンB** | 章区切り | 文字なし、世界観重視、抽象的/情緒的 | `章画像生成プロンプト.md` |

